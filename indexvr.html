<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AFTER HARRIER VR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #vr-info {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 12px;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
            z-index: 100;
            pointer-events: none;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #start-screen h1 {
            font-size: 48px;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff;
            margin-bottom: 40px;
            text-align: center;
        }

        #start-screen p {
            font-size: 16px;
            color: #ffff00;
            margin: 10px;
            text-align: center;
        }

        #start-screen button {
            margin-top: 30px;
            padding: 15px 30px;
            font-size: 20px;
            background: #00ffff;
            color: #000;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 5px #00ffff;
            transition: all 0.3s;
        }

        #start-screen button:hover {
            background: #ffff00;
            box-shadow: 0 0 20px #ffff00;
        }

        .hidden {
            display: none !important;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="game-container"></div>
    <div id="vr-info">
        <div>AFTER HARRIER VR</div>
        <div id="vr-status">Initializing...</div>
    </div>

    <div id="start-screen">
        <h1>AFTER<br>HARRIER<br>VR</h1>
        <p>WebXR対応 VRゲーム</p>
        <p>Meta Quest 2/3 推奨</p>
        <button id="enter-vr-btn">ENTER VR</button>
        <button id="start-flat-btn" style="margin-top: 10px;">PLAY FLAT</button>
    </div>

<script>
/**
 * AFTER HARRIER VR - WebXR対応版
 * Meta Quest等のVRヘッドセット対応
 */

// ============================================================================
// AUDIO SYSTEM
// ============================================================================

class AudioSynth {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.compressor = this.ctx.createDynamicsCompressor();
        this.compressor.connect(this.ctx.destination);
        
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.3;
        this.masterGain.connect(this.compressor);

        this.isPlaying = false;
        this.nextNoteTime = 0;
        this.beatCount = 0;
        this.mode = 'NORMAL';
        
        this.normalBassSequence = [110, 110, 220, 110, 164.8, 164.8, 110, 146.8];
        this.bossBassSequence = [55, 55, 55, 110, 55, 55, 73.4, 55];
    }

    async init() {
        if (this.ctx.state === 'suspended') await this.ctx.resume();
    }

    playBassNote(freq, time) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.0, time);
        gain.gain.linearRampToValueAtTime(0.4, time + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.01, time + (this.mode === 'BOSS' ? 0.09 : 0.12));
        const filter = this.ctx.createBiquadFilter();\n        filter.type = 'lowpass';
        filter.frequency.value = 600;
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(this.masterGain);
        osc.start(time);
        osc.stop(time + (this.mode === 'BOSS' ? 0.09 : 0.12));
    }

    playArpNote(time) {
        if (Math.random() > 0.6) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        const scale = [440, 523.25, 587.33, 659.25, 783.99];
        const freq = scale[Math.floor(Math.random() * scale.length)];
        osc.type = 'square';
        osc.frequency.value = freq * (Math.random() > 0.5 ? 2 : 1);
        gain.gain.setValueAtTime(0.03, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start(time);
        osc.stop(time + 0.1);
    }

    scheduler() {
        const tempo = this.mode === 'BOSS' ? 0.09 : 0.12;
        const sequence = this.mode === 'BOSS' ? this.bossBassSequence : this.normalBassSequence;

        while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
            const noteIndex = this.beatCount % sequence.length;
            this.playBassNote(sequence[noteIndex], this.nextNoteTime);
            if (this.mode === 'BOSS') {
                this.playArpNote(this.nextNoteTime);
            }
            this.nextNoteTime += tempo;
            this.beatCount++;
        }
        if (this.isPlaying) {
            this.timerID = requestAnimationFrame(this.scheduler.bind(this));
        }
    }

    startMusic() {
        if (this.isPlaying) return;
        this.isPlaying = true;
        this.nextNoteTime = this.ctx.currentTime + 0.1;
        this.scheduler();
    }

    stopMusic() {
        this.isPlaying = false;
        cancelAnimationFrame(this.timerID);
    }

    playNormalBGM() {
        this.mode = 'NORMAL';
        if (!this.isPlaying) this.startMusic();
    }

    playBossBGM() {
        this.mode = 'BOSS';
        if (!this.isPlaying) this.startMusic();
    }

    playShoot() {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(800, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.05);
        gain.gain.setValueAtTime(0.15, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.05);
    }

    playExplosion(type = 'MEDIUM') {
        const t = this.ctx.currentTime;
        const gain = this.ctx.createGain();
        gain.connect(this.masterGain);
        const osc = this.ctx.createOscillator();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(150, t);
        osc.frequency.exponentialRampToValueAtTime(50, t + 0.2);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        osc.connect(gain);
        osc.start(t);
        osc.stop(t + 0.2);
    }

    playWarning() {
        const t = this.ctx.currentTime;
        const gain = this.ctx.createGain();
        gain.connect(this.masterGain);
        const osc = this.ctx.createOscillator();
        osc.type = 'square';
        osc.frequency.setValueAtTime(800, t);
        osc.frequency.exponentialRampToValueAtTime(400, t + 0.1);
        gain.gain.setValueAtTime(0.2, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
        osc.connect(gain);
        osc.start(t);
        osc.stop(t + 0.1);
    }
}

// ============================================================================
// GAME STATE & THREE.JS SETUP
// ============================================================================

const GAME = {
    state: 'MENU', // MENU, PLAYING, BOSS_BATTLE, GAMEOVER
    score: 0,
    health: 100,
    level: 1,
    speed: 1.5,
    progress: 0,
    maxProgressFrames: 40 * 60,
    isVR: false,
    isRecovering: false,
    slowMoFactor: 1.0
};

const container = document.getElementById('game-container');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
scene.fog = new THREE.Fog(0x000000, 10, 120);

let camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 200);
camera.position.set(0, 3, 10);
camera.lookAt(0, 0, -20);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(1); // VR酔い対策：パフォーマンス優先
renderer.xr.enabled = true;
renderer.xr.setReferenceSpaceType('local');
container.appendChild(renderer.domElement);

// Lighting
const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0x00ffff, 0.8);
dirLight.position.set(10, 20, 10);
scene.add(dirLight);

// ============================================================================
// MATERIALS & PLAYER
// ============================================================================

const matPlayer = new THREE.MeshPhongMaterial({ color: 0xcccccc, flatShading: true });
const matEngine = new THREE.MeshBasicMaterial({ color: 0x00ffff });
const matEnemy = new THREE.MeshPhongMaterial({ color: 0xff3366, flatShading: true });
const matBullet = new THREE.MeshBasicMaterial({ color: 0xffff00 });

// Player
const playerGroup = new THREE.Group();
const shipGeo = new THREE.ConeGeometry(0.8, 3, 4);
shipGeo.rotateX(Math.PI / 2);
const shipMesh = new THREE.Mesh(shipGeo, matPlayer);
playerGroup.add(shipMesh);

const wingGeo = new THREE.BoxGeometry(3, 0.1, 0.8);
const wingMesh = new THREE.Mesh(wingGeo, matPlayer);
wingMesh.position.z = 0.5;
playerGroup.add(wingMesh);

const engineGeo = new THREE.ConeGeometry(0.3, 1, 8);
engineGeo.rotateX(-Math.PI / 2);
const engineMesh = new THREE.Mesh(engineGeo, matEngine);
engineMesh.position.z = 1.5;
playerGroup.add(engineMesh);

scene.add(playerGroup);
playerGroup.position.set(0, 2, 0);

// Environment
const gridHelper = new THREE.GridHelper(200, 100, 0x00aaff, 0x001133);
gridHelper.position.y = -2;
scene.add(gridHelper);

// ============================================================================\n// SPACE UI (HUD) - CanvasTexture方式\n// ============================================================================\n\nfunction createHUDTexture() {\n    const canvas = document.createElement('canvas');\n    canvas.width = 512;\n    canvas.height = 256;\n    const ctx = canvas.getContext('2d');\n    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n    ctx.strokeStyle = '#00ffff';\n    ctx.lineWidth = 2;\n    ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);\n    ctx.fillStyle = '#00ffff';\n    ctx.font = 'bold 20px monospace';\n    ctx.fillText('SCORE: 0', 30, 50);\n    ctx.fillText('HP: 100', 30, 100);\n    ctx.fillText('LEVEL: 1', 30, 150);\n    return new THREE.CanvasTexture(canvas);\n}\n\nconst hudTexture = createHUDTexture();\nconst hudMaterial = new THREE.MeshBasicMaterial({ map: hudTexture, transparent: true });\nconst hudGeo = new THREE.PlaneGeometry(4, 2);\nconst hudMesh = new THREE.Mesh(hudGeo, hudMaterial);\nhudMesh.position.set(0, 3, -5);\n\n// ============================================================================\n// GAME ENTITIES\n// ============================================================================\n\nlet enemies = [];\nlet bullets = [];\nlet particles = [];\nconst targetPos = { x: 0, y: 0 };\nlet frameCount = 0;\nconst audio = new AudioSynth();\n\n// ============================================================================\n// VR CONTROLLER INPUT\n// ============================================================================\n\nconst vrControllers = { left: null, right: null };\nconst vrInputState = {\n    pointingRay: new THREE.Ray(),\n    thumbstickX: 0,\n    thumbstickY: 0,\n    triggerPressed: false\n};\n\nfunction setupVRControllers() {\n    const controller1 = renderer.xr.getController(0);\n    const controller2 = renderer.xr.getController(1);\n    \n    scene.add(controller1);\n    scene.add(controller2);\n    \n    controller1.addEventListener('connected', (event) => {\n        vrControllers.left = event.data;\n        console.log('Left controller connected');\n    });\n    \n    controller2.addEventListener('connected', (event) => {\n        vrControllers.right = event.data;\n        console.log('Right controller connected');\n    });\n}\n\n// ============================================================================\n// GAME LOGIC\n// ============================================================================\n\nfunction startGame() {\n    GAME.state = 'PLAYING';\n    GAME.score = 0;\n    GAME.health = 100;\n    GAME.level = 1;\n    GAME.progress = 0;\n    GAME.speed = 1.5;\n    \n    enemies = [];\n    bullets = [];\n    particles = [];\n    \n    playerGroup.position.set(0, 2, 0);\n    playerGroup.rotation.set(0, 0, 0);\n    \n    if (!GAME.isVR) {\n        camera.position.set(0, 3, 10);\n        camera.lookAt(0, 0, -20);\n    }\n    \n    document.getElementById('start-screen').classList.add('hidden');\n    audio.playNormalBGM();\n}\n\nfunction handleInput(clientX, clientY) {\n    const rect = renderer.domElement.getBoundingClientRect();\n    const xRel = clientX - rect.left;\n    const yRel = clientY - rect.top;\n    const x = (xRel / rect.width) * 2 - 1;\n    const y = -(yRel / rect.height) * 2 + 1;\n    \n    const clampedX = Math.max(-1, Math.min(1, x));\n    const clampedY = Math.max(-1, Math.min(1, y));\n    \n    targetPos.x = clampedX * 7.5;\n    targetPos.y = clampedY * 5.0 + 3.0;\n}\n\nwindow.addEventListener('mousemove', (e) => {\n    if (GAME.state === 'PLAYING') {\n        handleInput(e.clientX, e.clientY);\n    }\n});\n\nwindow.addEventListener('touchmove', (e) => {\n    if (GAME.state === 'PLAYING') {\n        e.preventDefault();\n        handleInput(e.touches[0].clientX, e.touches[0].clientY);\n    }\n}, { passive: false });\n\n// ============================================================================\n// VR MODE SETUP\n// ============================================================================\n\ndocument.getElementById('enter-vr-btn').addEventListener('click', async () => {\n    try {\n        await audio.init();\n        if (navigator.xr) {\n            const session = await navigator.xr.requestSession('immersive-vr', {\n                requiredFeatures: ['local'],\n                optionalFeatures: ['hand-tracking']\n            });\n            GAME.isVR = true;\n            setupVRControllers();\n            renderer.xr.setSession(session);\n            startGame();\n        } else {\n            alert('WebXR not supported on this device');\n        }\n    } catch (err) {\n        console.error('VR initialization failed:', err);\n        alert('Failed to initialize VR');\n    }\n});\n\ndocument.getElementById('start-flat-btn').addEventListener('click', async () => {\n    await audio.init();\n    GAME.isVR = false;\n    startGame();\n});\n\n// ============================================================================\n// MAIN ANIMATION LOOP\n// ============================================================================\n\nfunction animate() {\n    renderer.render(scene, camera);\n}\n\nrenderer.setAnimationLoop(animate);\n\n// ============================================================================\n// WINDOW RESIZE\n// ============================================================================\n\nwindow.addEventListener('resize', () => {\n    if (!GAME.isVR) {\n        camera.aspect = window.innerWidth / window.innerHeight;\n        camera.updateProjectionMatrix();\n        renderer.setSize(window.innerWidth, window.innerHeight);\n    }\n});\n\n// Initialize\ndocument.getElementById('vr-status').textContent = navigator.xr ? 'Ready' : 'WebXR Not Available';\n\n</script>\n</body>\n</html>\nEOFHTML

